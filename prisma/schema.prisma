// Prisma schema for Tesland2026 - PostgreSQL database
// Migrated from Firestore collections

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USERS & ROLES
// ========================================

model User {
  id            String    @id @default(uuid())
  uid           String?   @unique // Optional: For backward compatibility with Firebase
  email         String    @unique
  password      String? // Bcrypt hashed password (nullable for passwordless customer accounts)
  displayName   String?   @map("display_name")
  photoURL      String?   @map("photo_url")
  phoneNumber   String?   @map("phone_number")
  roleId        String?   @map("role_id")
  role          String? // Legacy/denormalized role name - DO NOT UPDATE DIRECTLY
  isSystemAdmin Boolean   @default(false) @map("is_system_admin")
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  customerId    String?   @map("customer_id") // Optional link for webshop customer accounts

  // Planning fields
  color               String?  @default("#4f46e5")
  planningHoursPerDay Float?   @map("planning_hours_per_day")
  workingDays         String[] @default([]) @map("working_days")

  // Profile settings
  profilePhoto    String? @map("profile_photo")
  backgroundPhoto String? @map("background_photo")
  transparency    Int?    @default(30)
  language        String?

  // External calendar integration
  icalUrl String? @map("ical_url")

  // VoIP integration
  voipExtension String? @map("voip_extension") // Eindbestemming (bijv. "206")

  // HR - Personal Information
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  dateOfBirth     DateTime? @map("date_of_birth")
  address         String?
  city            String?
  postalCode      String?   @map("postal_code")
  country         String?   @default("Nederland")
  
  // HR - Employment Information
  employmentStartDate    DateTime? @map("employment_start_date")
  employmentEndDate      DateTime? @map("employment_end_date")
  hasFixedTermContract   Boolean?  @default(false) @map("has_fixed_term_contract")
  contractHoursPerWeek   Float?    @map("contract_hours_per_week")
  annualLeaveDaysOrHours Float?    @map("annual_leave_days_or_hours")
  
  // HR - Emergency Contact
  emergencyContactName         String? @map("emergency_contact_name")
  emergencyContactRelation     String? @map("emergency_contact_relation")
  emergencyContactPhone        String? @map("emergency_contact_phone")
  emergencyContactEmail        String? @map("emergency_contact_email")
  
  // HR - Financial Information
  privateEmail String? @map("private_email")
  iban         String? @map("iban")
  
  // HR - Notes
  hrNotes String? @map("hr_notes")

  // Verlof tegoed - SPLIT: Wettelijk en Bovenwettelijk
  leaveBalanceLegal     Float?    @default(0) @map("leave_balance_legal")     // Wettelijke verlofdagen (20 dagen in NL)
  leaveBalanceExtra     Float?    @default(0) @map("leave_balance_extra")     // Bovenwettelijke verlofdagen
  leaveBalanceCarryover Float?    @default(0) @map("leave_balance_carryover")
  leaveBalanceSpecial   Float?    @default(0) @map("leave_balance_special")
  leaveUnit             String?   @default("DAYS") @map("leave_unit")
  hoursPerDay           Float?    @default(8) @map("hours_per_day")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  roleRef               Role?            @relation(fields: [roleId], references: [id])
  customer              Customer?        @relation(fields: [customerId], references: [id], onDelete: SetNull)
  workOrders            WorkOrder[]      @relation("assignee")
  planningItems         PlanningItem[]   @relation("assignee")
  laborLines            LaborLine[]      @relation("labor_user")
  uploadedPhotos        WorkOrderPhoto[] @relation("photo_uploader")
  auditLogs             AuditLog[]
  notifications         Notification[]
  preferences           UserPreference[]
  leaveRequests         LeaveRequest[]   @relation("employee")
  reviewedLeaveRequests LeaveRequest[]   @relation("reviewer")
  leaveBalances         LeaveBalance[]
  leaveLedger           LeaveLedger[]    @relation("ledger")
  workSessions          WorkSession[]    @relation("work_sessions")

  @@index([customerId])
  @@map("users")
}

model CustomerLoginCode {
  id         String    @id @default(uuid())
  email      String
  customerId String?   @map("customer_id")
  codeHash   String    @map("code_hash")
  expiresAt  DateTime  @map("expires_at")
  consumedAt DateTime? @map("consumed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent") @db.Text

  // Relations
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([customerId])
  @@index([expiresAt])
  @@map("customer_login_codes")
}

model UserPreference {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  key       String // e.g., "vehicles-columns", "vehicles-column-order", etc.
  value     Json // Store the preference data as JSON
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@map("user_preferences")
}

model Role {
  id                String   @id @default(uuid())
  name              String   @unique
  isSystemAdmin     Boolean  @default(false) @map("is_system_admin")
  includeInPlanning Boolean  @default(false) @map("include_in_planning")
  permissions       Json? // Store as JSONB for flexibility
  description       String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  users User[]

  @@map("roles")
}

// ========================================
// CUSTOMERS & VEHICLES
// ========================================

model Customer {
  id                String  @id @default(uuid())
  name              String
  email             String?
  phone             String?
  mobile            String?
  fax               String?
  company           String?
  contact           String? // Contact persoon
  address           Json? // Store address as JSONB
  street            String?
  zipCode           String? @map("zip_code")
  city              String?
  countryId         String? @map("country_id")
  customerNumber    String? @map("customer_number")
  displayName       String? @map("display_name")
  emailDestinations String? @map("email_destinations") @db.Text
  branchId          String? @map("branch_id")
  extra1            String? @map("extra_1")
  notes             String? @db.Text
  externalId        String? @map("external_id") // For Automaat/Magento import
  source            String? @default("manual") // manual, automaat, magento

  // BTW fields
  vatNumber            String?   @map("vat_number") // BTW nummer (NL123456789B01)
  vatNumberValidated   Boolean?  @default(false) @map("vat_number_validated") // VIES check result
  vatNumberValidatedAt DateTime? @map("vat_number_validated_at") // Last VIES check
  isBusinessCustomer   Boolean   @default(false) @map("is_business_customer") // B2B vs B2C
  vatReversed          Boolean   @default(false) @map("vat_reversed") // BTW verlegd
  vatExempt            Boolean   @default(false) @map("vat_exempt") // Vrijgesteld van BTW

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  vehicles       Vehicle[]
  workOrders     WorkOrder[]
  planningItems  PlanningItem[]
  invoices       Invoice[]
  creditInvoices CreditInvoice[]
  orders         Order[]
  rmas           Rma[]
  users          User[]
  carts          Cart[]
  loginCodes     CustomerLoginCode[]

  @@index([vatNumber])
  @@index([isBusinessCustomer])
  @@map("customers")
}

model Vehicle {
  id               String    @id @default(uuid())
  customerId       String?   @map("customer_id")
  licensePlate     String    @unique @map("license_plate")
  make             String?
  model            String?
  year             Int?
  vin              String?
  color            String?
  mileage          Int? // Kilometrage
  apkDueDate       DateTime? @map("apk_due_date") // APK vervaldatum
  constructionDate DateTime? @map("construction_date") // Bouwdatum
  isHistory        Boolean?  @map("is_history") // Automaat history flag
  deleted          Boolean? // Automaat deleted flag
  notes            String?   @db.Text
  rdwData          Json?     @map("rdw_data") // RDW API response
  externalId       String?   @map("external_id") // Automaat ID

  // RDW flattened fields for easy access
  rdwChassisNumber         String? @map("rdw_chassis_number")
  rdwColor                 String? @map("rdw_color")
  rdwVehicleType           String? @map("rdw_vehicle_type")
  rdwEngineCode            String? @map("rdw_engine_code")
  rdwBuildYear             Int?    @map("rdw_build_year")
  rdwRegistrationDatePart1 String? @map("rdw_registration_date_part1")
  rdwOwnerSince            String? @map("rdw_owner_since")
  rdwOwnerCount            Int?    @map("rdw_owner_count")
  rdwApkDueDate            String? @map("rdw_apk_due_date")
  rdwOdometer              Int?    @map("rdw_odometer")
  rdwOdometerJudgement     String? @map("rdw_odometer_judgement")
  rdwFuelType              String? @map("rdw_fuel_type")
  rdwEmptyWeight           Int?    @map("rdw_empty_weight")
  rdwMaxTowWeightBraked    Int?    @map("rdw_max_tow_weight_braked")
  rdwMaxTowWeightUnbraked  Int?    @map("rdw_max_tow_weight_unbraked")
  rdwMaxMass               Int?    @map("rdw_max_mass")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  customer      Customer?      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  workOrders    WorkOrder[]
  planningItems PlanningItem[]
  orders        Order[]

  @@index([customerId])
  @@map("vehicles")
}

// ========================================
// PLANNING & WORK ORDERS
// ========================================

model PlanningItem {
  id                String   @id // Custom ID like PLN-20240123-143045-123
  title             String
  scheduledAt       DateTime @map("scheduled_at")
  durationMinutes   Int      @default(60) @map("duration_minutes")
  assigneeId        String?  @map("assignee_id")
  assigneeName      String?  @map("assignee_name")
  assigneeColor     String?  @map("assignee_color")
  location          String?
  customerId        String?  @map("customer_id")
  customerName      String?  @map("customer_name")
  vehicleId         String?  @map("vehicle_id")
  vehiclePlate      String?  @map("vehicle_plate")
  vehicleLabel      String?  @map("vehicle_label")
  planningTypeId    String?  @map("planning_type_id")
  planningTypeName  String?  @map("planning_type_name")
  planningTypeColor String?  @map("planning_type_color")
  notes             String?  @db.Text
  status            String?  @default("GEPLAND")
  workOrderId       String?  @unique @map("work_order_id") // Link to work order
  priority          String?  @default("NORMAL")
  assignmentText    String?  @map("assignment_text") @db.Text // JSON array of checklist items
  agreementAmount   Decimal? @map("agreement_amount") @db.Decimal(10, 2) // Agreed amount
  agreementNotes    String?  @map("agreement_notes") @db.Text // Agreement notes
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  assignee      User?          @relation("assignee", fields: [assigneeId], references: [id])
  customer      Customer?      @relation(fields: [customerId], references: [id])
  vehicle       Vehicle?       @relation(fields: [vehicleId], references: [id])
  planningType  PlanningType?  @relation(fields: [planningTypeId], references: [id])
  workOrder     WorkOrder?     @relation(fields: [workOrderId], references: [id])
  leaveRequest  LeaveRequest?  // One-to-one relation: a planning item may be linked to a leave request

  @@index([scheduledAt])
  @@index([assigneeId])
  @@index([customerId])
  @@index([workOrderId])
  @@map("planning_items")
}

model PlanningType {
  id              String   @id @default(uuid())
  name            String   @unique
  color           String?
  description     String?
  defaultDuration Int?     @map("default_duration")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  planningItems PlanningItem[]

  @@map("planning_types")
}

model WorkOrder {
  id              String    @id @default(uuid())
  workOrderNumber String    @unique @map("work_order_number") // WO-2024-0001
  title           String
  description     String?   @db.Text
  workOrderStatus String    @default("DRAFT") @map("work_order_status")
  executionStatus String?   @map("execution_status")
  warehouseStatus String?   @map("warehouse_status")
  customerId      String?   @map("customer_id")
  customerName    String?   @map("customer_name")
  vehicleId       String?   @map("vehicle_id")
  vehiclePlate    String?   @map("vehicle_plate")
  vehicleLabel    String?   @map("vehicle_label")
  assigneeId      String?   @map("assignee_id")
  assigneeName    String?   @map("assignee_name")
  licensePlate    String?   @map("license_plate")
  scheduledAt     DateTime? @map("scheduled_at")
  completedAt     DateTime? @map("completed_at")

  // Pricing
  pricingMode      String?   @map("pricing_mode")
  estimatedAmount  Decimal?  @map("estimated_amount") @db.Decimal(10, 2)
  priceAmount      Decimal?  @map("price_amount") @db.Decimal(10, 2)
  currency         String?   @default("EUR")
  customerApproved Boolean?  @map("customer_approved")
  approvalDate     DateTime? @map("approval_date")

  // Parts & Warehouse Management
  // partsSummaryStatus is a CACHE calculated from partsLines for performance
  // Updated via syncWorkOrderStatus() when parts change
  partsSummaryStatus  String?   @map("parts_summary_status")
  partsRequired       Boolean   @default(false) @map("parts_required")
  normalStockProducts Boolean   @default(false) @map("normal_stock_products") // Magazijn: "Normale voorraadproducten"
  planningRiskActive  Boolean   @default(false) @map("planning_risk_active")
  planningRiskHistory Json?     @map("planning_risk_history") // Array of risk events
  warehouseHistory    Json?     @map("warehouse_history") // Array of warehouse status changes
  warehouseEtaDate    DateTime? @map("warehouse_eta_date")
  warehouseLocation   String?   @map("warehouse_location")
  missingItemsCount   Int?      @default(0) @map("missing_items_count")

  // Status history
  statusHistory Json? @map("status_history") // Array of status transitions

  // Additional fields
  priority      String? @default("NORMAL")
  notes         String? @db.Text
  internalNotes String? @map("internal_notes") @db.Text
  customerNotes String? @map("customer_notes") @db.Text

  // Customer signature (intake/approval)
  customerSignature     String?   @map("customer_signature") @db.Text // Base64 encoded signature image
  customerSignedAt      DateTime? @map("customer_signed_at")
  customerSignedBy      String?   @map("customer_signed_by") // Customer name
  signatureIpAddress    String?   @map("signature_ip_address")
  vehiclePinCode        String?   @map("vehicle_pin_code") // Pincode van het voertuig
  
  // Work Overview tracking
  workOverviewColumn    String?   @map("work_overview_column") // Kolom in werkoverzicht (bijv. "Auto Binnen", "In Behandeling")
  activeWorkStartedAt   DateTime? @map("active_work_started_at") // Wanneer monteur begonnen is
  activeWorkStartedBy   String?   @map("active_work_started_by") // Wie is ermee bezig
  activeWorkStartedByName String? @map("active_work_started_by_name") // Naam van monteur

  // Monteur: bevestiging onderdelen/materialen bij "Gereed"
  partsAndMaterialsCheckedAt DateTime? @map("parts_and_materials_checked_at")
  partsAndMaterialsCheckedBy String?  @map("parts_and_materials_checked_by")

  // Monteur: actuele kilometerstand bij deze werkorder (of aangeven geen stand)
  mileageAtCompletion  Int?     @map("mileage_at_completion")   // Ingevuld door monteur; later naar RDW
  mileageNotAvailable   Boolean? @map("mileage_not_available")  // Vinkje "geen kilometerstand"

  // Management: facturatie-voorbereiding (werkzaamheden/onderdelen afgevinkt, uren bevestigd, tariefkeuze)
  invoicePrepWorkPartsCheckedAt DateTime? @map("invoice_prep_work_parts_checked_at")
  invoicePrepHoursConfirmedAt   DateTime? @map("invoice_prep_hours_confirmed_at")
  laborBillingMode   String?   @map("labor_billing_mode") // PLANNED | ACTUAL | FIXED
  laborFixedAmount   Decimal?  @map("labor_fixed_amount") @db.Decimal(10, 2) // bij FIXED
  laborHourlyRateName String?  @map("labor_hourly_rate_name") // gekozen tarief uit werkplaatstarieven (bij PLANNED/ACTUAL)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  // Relations
  customer     Customer?        @relation(fields: [customerId], references: [id])
  vehicle      Vehicle?         @relation(fields: [vehicleId], references: [id])
  assignee     User?            @relation("assignee", fields: [assigneeId], references: [id])
  planningItem PlanningItem?
  partsLines   PartsLine[]
  laborLines   LaborLine[]
  photos       WorkOrderPhoto[]
  stockMoves   StockMove[]
  backOrders   BackOrder[]
  workSessions WorkSession[]

  @@index([workOrderNumber])
  @@index([workOrderStatus])
  @@index([customerId])
  @@index([vehicleId])
  @@index([assigneeId])
  @@index([partsSummaryStatus])
  @@map("work_orders")
}

// ========================================
// INVENTORY & PARTS
// ========================================

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  name        String
  description String?  @db.Text
  category    String?
  price       Decimal? @db.Decimal(10, 2)
  cost        Decimal? @db.Decimal(10, 2)
  stock       Int?     @default(0)
  unit        String?
  supplier    String?
  supplierSku String?  @map("supplier_sku")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  partsLines PartsLine[]
  stockMoves StockMove[]
  backOrders BackOrder[]

  @@map("products")
}

model PartsLine {
  id            String    @id @default(uuid())
  workOrderId   String    @map("work_order_id")
  productId     String?   @map("product_id")
  productName   String?   @map("product_name")
  articleNumber String?   @map("article_number")
  quantity      Int       @default(1)
  unitPrice     Decimal?  @map("unit_price") @db.Decimal(10, 2)
  totalPrice    Decimal?  @map("total_price") @db.Decimal(10, 2)
  status        String    @default("PENDING")
  statusHistory Json?     @map("status_history") // Array of status changes
  locationId    String?   @map("location_id")
  etaDate       DateTime? @map("eta_date")
  notes         String?   @db.Text
  supplier      String?   @db.Text // Leverancier van het onderdeel

  // BTW fields
  vatRateId     String?  @map("vat_rate_id")
  vatRate       VatRate? @relation(fields: [vatRateId], references: [id])
  vatPercentage Decimal? @map("vat_percentage") @db.Decimal(5, 2) // Snapshot of rate at time of creation
  vatAmount     Decimal? @map("vat_amount") @db.Decimal(10, 2)
  subtotal      Decimal? @map("subtotal") @db.Decimal(10, 2) // Amount without VAT

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workOrder  WorkOrder          @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  product    Product?           @relation(fields: [productId], references: [id])
  location   InventoryLocation? @relation(fields: [locationId], references: [id])
  stockMoves StockMove[]
  backOrders BackOrder[]

  @@index([workOrderId])
  @@index([productId])
  @@index([status])
  @@index([vatRateId])
  @@map("parts_lines")
}

model BackOrder {
  id             String    @id @default(uuid())
  partsLineId    String    @map("parts_line_id")
  workOrderId    String    @map("work_order_id")
  productId      String?   @map("product_id")
  productName    String    @map("product_name")
  sku            String?
  quantityNeeded Int       @map("quantity_needed")
  quantityOrdered Int?     @default(0) @map("quantity_ordered")
  quantityReceived Int?    @default(0) @map("quantity_received")
  
  status         String    @default("PENDING") // PENDING, ORDERED, PARTIALLY_RECEIVED, RECEIVED, CANCELLED
  priority       String    @default("NORMAL") // HIGH, NORMAL, LOW
  
  // Order details
  supplier       String?   @db.Text
  orderDate      DateTime? @map("order_date")
  expectedDate   DateTime? @map("expected_date")
  receivedDate   DateTime? @map("received_date")
  orderReference String?   @map("order_reference") // PO number, invoice, etc.
  unitCost       Decimal?  @map("unit_cost") @db.Decimal(10, 2)
  totalCost      Decimal?  @map("total_cost") @db.Decimal(10, 2)
  
  // Work order context
  workOrderNumber   String?   @map("work_order_number")
  customerName      String?   @map("customer_name")
  vehiclePlate      String?   @map("vehicle_plate")
  workOrderScheduled DateTime? @map("work_order_scheduled")
  
  notes          String?   @db.Text
  createdBy      String?   @map("created_by")
  updatedBy      String?   @map("updated_by")
  
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  partsLine PartsLine @relation(fields: [partsLineId], references: [id], onDelete: Cascade)
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  product   Product?  @relation(fields: [productId], references: [id])

  @@index([status])
  @@index([priority])
  @@index([workOrderId])
  @@index([productId])
  @@index([partsLineId])
  @@index([expectedDate])
  @@map("back_orders")
}

model InventoryLocation {
  id          String   @id @default(uuid())
  name        String   @unique
  code        String?
  description String?
  type        String? // warehouse, shelf, bin, etc.
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  partsLines     PartsLine[]
  stockMovesFrom StockMove[] @relation("from_location")
  stockMovesTo   StockMove[] @relation("to_location")

  @@map("inventory_locations")
}

model StockMove {
  id             String   @id @default(uuid())
  moveType       String   @map("move_type") // in, out, transfer, adjustment
  quantity       Int
  productId      String?  @map("product_id")
  workOrderId    String?  @map("work_order_id")
  partsLineId    String?  @map("parts_line_id")
  fromLocationId String?  @map("from_location_id")
  toLocationId   String?  @map("to_location_id")
  reason         String?
  notes          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  createdBy      String?  @map("created_by")

  // Relations
  product      Product?           @relation(fields: [productId], references: [id])
  workOrder    WorkOrder?         @relation(fields: [workOrderId], references: [id])
  partsLine    PartsLine?         @relation(fields: [partsLineId], references: [id])
  fromLocation InventoryLocation? @relation("from_location", fields: [fromLocationId], references: [id])
  toLocation   InventoryLocation? @relation("to_location", fields: [toLocationId], references: [id])

  @@index([productId])
  @@index([workOrderId])
  @@index([moveType])
  @@index([createdAt])
  @@map("stock_moves")
}

// ========================================
// LABOR & PHOTOS
// ========================================

model LaborLine {
  id              String   @id @default(uuid())
  workOrderId     String   @map("work_order_id")
  description     String
  userId          String?  @map("user_id")
  userName        String?  @map("user_name")
  durationMinutes Int      @default(0) @map("duration_minutes")
  hourlyRate      Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  totalAmount     Decimal? @map("total_amount") @db.Decimal(10, 2)
  notes           String?  @db.Text
  completed       Boolean  @default(false) // Checkbox status voor monteurs
  completedBy     String?  @map("completed_by")
  completedByName String?  @map("completed_by_name") // initialen monteur
  completedAt     DateTime? @map("completed_at")

  // BTW fields
  vatRateId     String?  @map("vat_rate_id")
  vatRate       VatRate? @relation(fields: [vatRateId], references: [id])
  vatPercentage Decimal? @map("vat_percentage") @db.Decimal(5, 2) // Snapshot of rate at time of creation
  vatAmount     Decimal? @map("vat_amount") @db.Decimal(10, 2)
  subtotal      Decimal? @map("subtotal") @db.Decimal(10, 2) // Amount without VAT

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user      User?     @relation("labor_user", fields: [userId], references: [id])

  @@index([workOrderId])
  @@index([vatRateId])
  @@map("labor_lines")
}

model WorkOrderPhoto {
  id          String   @id @default(uuid())
  workOrderId String   @map("work_order_id")
  url         String
  filename    String?
  description String?
  type        String   @default("general") // general, before, after, damage
  uploadedBy  String?  @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  uploader  User?     @relation("photo_uploader", fields: [uploadedBy], references: [id])

  @@index([workOrderId])
  @@map("work_order_photos")
}

model WorkSession {
  id              String    @id @default(uuid())
  workOrderId     String    @map("work_order_id")
  userId          String    @map("user_id")
  userName        String    @map("user_name")
  startedAt       DateTime  @default(now()) @map("started_at")
  endedAt         DateTime? @map("ended_at")
  durationMinutes Int?      @map("duration_minutes")
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user      User      @relation("work_sessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([userId])
  @@index([endedAt])
  @@map("work_sessions")
}

// ========================================
// ORDERS & INVOICES
// ========================================

model Order {
  id             String    @id @default(uuid())
  orderNumber    String    @unique @map("order_number")
  title          String?
  customerId     String?   @map("customer_id")
  vehicleId      String?   @map("vehicle_id")
  vehiclePlate   String?   @map("vehicle_plate")
  vehicleLabel   String?   @map("vehicle_label")
  orderStatus    String?   @map("order_status")
  paymentStatus  String?   @map("payment_status")
  shipmentStatus String?   @map("shipment_status")
  paymentMethod  String?   @map("payment_method")
  shippingMethod String?   @map("shipping_method")
  totalAmount    Decimal?  @map("total_amount") @db.Decimal(10, 2)
  subtotalAmount Decimal?  @map("subtotal_amount") @db.Decimal(10, 2)
  vatTotal       Decimal?  @map("vat_total") @db.Decimal(10, 2)
  shippingCost   Decimal?  @map("shipping_cost") @db.Decimal(10, 2)
  currency       String?   @default("EUR")
  customerEmail  String?   @map("customer_email")
  billingAddress Json?     @map("billing_address")
  shippingAddress Json?    @map("shipping_address")
  placedAt       DateTime? @map("placed_at")
  paidAt         DateTime? @map("paid_at")
  shippingCarrier String?  @map("shipping_carrier")
  shippingTrackingCode String? @map("shipping_tracking_code")
  scheduledAt    DateTime? @map("scheduled_at")
  notes          String?   @db.Text
  orderDate      DateTime? @map("order_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  customer       Customer?       @relation(fields: [customerId], references: [id])
  vehicle        Vehicle?        @relation(fields: [vehicleId], references: [id])
  invoices       Invoice[]
  creditInvoices CreditInvoice[] @relation("CreditInvoiceOrder")
  rmas           Rma[]           @relation("RmaOrder")
  lines          OrderLine[]
  shipments      Shipment[]

  @@index([customerId])
  @@index([vehicleId])
  @@map("orders")
}

model Shipment {
  id             String   @id @default(uuid())
  orderId         String   @map("order_id")
  carrier         String
  trackingCode    String   @map("tracking_code")
  labelPdfBase64  String?  @map("label_pdf_base64") @db.Text
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingCode])
  @@map("shipments")
}

model Cart {
  id         String   @id @default(uuid())
  token      String   @unique
  customerId String?  @map("customer_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items    CartItem[]

  @@index([customerId])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String   @map("cart_id")
  productId String   @map("product_id")
  quantity  Int      @default(1)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cart    Cart          @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product ProductCatalog @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model OrderLine {
  id              String   @id @default(uuid())
  orderId         String   @map("order_id")
  productId       String?  @map("product_id") // ProductCatalog.id (optional snapshot)
  sku             String   @map("sku")
  name            String   @map("name")
  quantity        Int      @default(1)
  unitPrice       Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice      Decimal  @map("total_price") @db.Decimal(10, 2)
  vatRate         Decimal? @map("vat_rate") @db.Decimal(5, 2)
  vatAmount       Decimal? @map("vat_amount") @db.Decimal(10, 2)
  metadata        Json?    // Options/configuration snapshot (e.g. custom options)
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product ProductCatalog? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@map("order_lines")
}

model PurchaseOrder {
  id           String    @id @default(uuid())
  poNumber     String    @unique @map("po_number")
  supplier     String?
  status       String    @default("DRAFT")
  totalAmount  Decimal?  @map("total_amount") @db.Decimal(10, 2)
  notes        String?   @db.Text
  orderDate    DateTime? @map("order_date")
  expectedDate DateTime? @map("expected_date")
  receivedDate DateTime? @map("received_date")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("purchase_orders")
}

model Invoice {
  id            String  @id @default(uuid())
  invoiceNumber String  @unique @map("invoice_number")
  title         String?
  customerId    String? @map("customer_id")
  orderId       String? @map("order_id")
  vehiclePlate  String? @map("vehicle_plate")
  vehicleLabel  String? @map("vehicle_label")
  status        String  @default("DRAFT")
  paymentStatus String? @map("payment_status")

  // Bedragen
  totalAmount    Decimal  @map("total_amount") @db.Decimal(10, 2) // Totaal inclusief BTW
  subtotalAmount Decimal? @map("subtotal_amount") @db.Decimal(10, 2) // Totaal exclusief BTW
  taxAmount      Decimal? @map("tax_amount") @db.Decimal(10, 2) // Deprecated - use vatTotal

  // BTW details
  vatSubtotalHigh Decimal? @default(0) @map("vat_subtotal_high") @db.Decimal(10, 2) // Subtotaal 21%
  vatAmountHigh   Decimal? @default(0) @map("vat_amount_high") @db.Decimal(10, 2) // BTW 21%
  vatSubtotalLow  Decimal? @default(0) @map("vat_subtotal_low") @db.Decimal(10, 2) // Subtotaal 9%
  vatAmountLow    Decimal? @default(0) @map("vat_amount_low") @db.Decimal(10, 2) // BTW 9%
  vatSubtotalZero Decimal? @default(0) @map("vat_subtotal_zero") @db.Decimal(10, 2) // Subtotaal 0%
  vatTotal        Decimal? @default(0) @map("vat_total") @db.Decimal(10, 2) // Totaal BTW

  // BTW regeling
  vatReversed     Boolean @default(false) @map("vat_reversed") // BTW verlegd
  vatReversedText String? @map("vat_reversed_text") // "BTW verlegd art. 12(b) Wet OB"
  vatExempt       Boolean @default(false) @map("vat_exempt") // BTW vrijgesteld
  vatExemptReason String? @map("vat_exempt_reason")

  // Klant BTW info (snapshot)
  customerVatNumber String? @map("customer_vat_number") // BTW nummer klant
  customerIsB2B     Boolean @default(false) @map("customer_is_b2b") // Is zakelijke klant

  notes       String?   @db.Text
  invoiceDate DateTime  @map("invoice_date")
  dueDate     DateTime? @map("due_date")
  paidDate    DateTime? @map("paid_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  customer Customer? @relation(fields: [customerId], references: [id])
  order    Order?    @relation(fields: [orderId], references: [id])
  payments Payment[]

  @@index([invoiceNumber])
  @@index([customerId])
  @@index([orderId])
  @@index([invoiceDate])
  @@index([vatReversed])
  @@map("invoices")
}

model Payment {
  id                 String    @id @default(uuid())
  invoiceId          String?   @map("invoice_id") // null tot factuur na betaling is aangemaakt (webshop)
  provider           String    @default("MOLLIE") // MOLLIE, STRIPE, MANUAL, etc.
  providerPaymentId  String?   @map("provider_payment_id") // External payment ID
  amount             Decimal   @db.Decimal(10, 2)
  currency           String    @default("EUR")
  status             String    @default("open") // open, paid, canceled, expired, failed
  description        String?
  checkoutUrl        String?   @map("checkout_url") @db.Text
  webhookUrl         String?   @map("webhook_url") @db.Text
  metadata           Json?     // Extra payment metadata
  
  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  paidAt     DateTime? @map("paid_at")
  canceledAt DateTime? @map("canceled_at")
  expiredAt  DateTime? @map("expired_at")
  failedAt   DateTime? @map("failed_at")
  
  // Audit
  createdBy String? @map("created_by")
  
  // Relations
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
  @@index([providerPaymentId])
  @@index([status])
  @@map("payments")
}

model CreditInvoice {
  id              String   @id @default(uuid())
  creditNumber    String   @unique @map("credit_number")
  title           String?
  customerId      String?  @map("customer_id")
  orderId         String?  @map("order_id")
  originalInvoice String?  @map("original_invoice")
  vehiclePlate    String?  @map("vehicle_plate")
  vehicleLabel    String?  @map("vehicle_label")
  status          String   @default("DRAFT")
  totalAmount     Decimal  @map("total_amount") @db.Decimal(10, 2)
  taxAmount       Decimal? @map("tax_amount") @db.Decimal(10, 2)
  reason          String?  @db.Text
  notes           String?  @db.Text
  creditDate      DateTime @map("credit_date")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  customer Customer? @relation(fields: [customerId], references: [id])
  order    Order?    @relation(fields: [orderId], references: [id], name: "CreditInvoiceOrder")

  @@index([creditNumber])
  @@index([customerId])
  @@index([orderId])
  @@map("credit_invoices")
}

model Rma {
  id           String   @id @default(uuid())
  rmaNumber    String   @unique @map("rma_number")
  title        String?
  customerId   String?  @map("customer_id")
  orderId      String?  @map("order_id")
  vehiclePlate String?  @map("vehicle_plate")
  vehicleLabel String?  @map("vehicle_label")
  productSku   String?  @map("product_sku")
  productName  String?  @map("product_name")
  reason       String?  @db.Text
  status       String   @default("PENDING")
  quantity     Int      @default(1)
  resolution   String?
  notes        String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  customer Customer? @relation(fields: [customerId], references: [id])
  order    Order?    @relation(fields: [orderId], references: [id], name: "RmaOrder")

  @@index([rmaNumber])
  @@index([customerId])
  @@index([orderId])
  @@map("rmas")
}

// ========================================
// SETTINGS & CONFIGURATION
// ========================================

model Setting {
  id        String   @id @default(uuid())
  group     String   @unique // 'planning', 'email', 'ui', 'rdwSettings', etc.
  data      Json // Store all settings as JSONB
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model EmailTemplate {
  id        String   @id // Template ID like 'workorder-created'
  name      String
  subject   String
  body      String   @db.Text
  variables Json? // Available template variables
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("email_templates")
}

model EmailLog {
  id         String   @id @default(uuid())
  to         String
  from       String?
  subject    String
  templateId String?  @map("template_id")
  status     String   @default("sent")
  error      String?  @db.Text
  sentAt     DateTime @map("sent_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([sentAt])
  @@index([templateId])
  @@map("email_logs")
}

model Page {
  id              String   @id // Slug like '_home', 'about', etc.
  title           String
  content         Json // Store page content as JSONB
  slug            String   @unique
  isPublished     Boolean  @default(false) @map("is_published")
  metaDescription String?  @map("meta_description")
  metaKeywords    String?  @map("meta_keywords")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("pages")
}

// ========================================
// LOGS & AUDIT
// ========================================

model AuditLog {
  id String @id @default(uuid())

  // What was changed?
  entityType String  @map("entity_type") // WorkOrder, Invoice, Planning, Customer, etc.
  entityId   String? @map("entity_id")
  action     String // CREATE, UPDATE, DELETE, STATUS_CHANGE, PAYMENT_RECEIVED, etc.

  // Who made the change?
  userId    String? @map("user_id")
  userName  String? @map("user_name") // Denormalized for history
  userEmail String? @map("user_email") // Denormalized for history
  userRole  String? @map("user_role") // Denormalized for history

  // When?
  timestamp DateTime @default(now())

  // Details
  changes     Json?   // Field-level changes: {"field": {"from": "old", "to": "new"}}
  metadata    Json?   // Additional context (IP, browser, business context)
  description String? @db.Text // Human-readable description

  // System info
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp(sort: Desc)])
  @@index([action])
  @@index([entityType, entityId, timestamp(sort: Desc)])
  @@map("audit_logs")
}

model RdwLog {
  id           String   @id @default(uuid())
  licensePlate String   @map("license_plate")
  requestType  String   @map("request_type")
  response     Json?
  success      Boolean
  error        String?  @db.Text
  timestamp    DateTime @default(now())

  @@index([licensePlate])
  @@index([timestamp])
  @@map("rdw_logs")
}

model Notification {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  title       String
  message     String    @db.Text
  type        String?   @default("info")
  isRead      Boolean   @default(false) @map("is_read")
  readBy      String[]  @default([]) @map("read_by")
  link        String?
  notifyAt    DateTime? @map("notify_at")
  workOrderId String?   @map("work_order_id")
  riskReason  String?   @map("risk_reason")
  meta        Json?
  createdBy   String?   @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ========================================
// COUNTERS
// ========================================

model Counter {
  id           String   @id // Counter name like 'workorders', 'invoices'
  currentValue Int      @default(0) @map("current_value")
  prefix       String?
  format       String? // Format string like 'WO-{year}-{counter}'
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("counters")
}

// ========================================
// MAGENTO PRODUCT CATALOG
// ========================================

model Category {
  id          String   @id @default(uuid())
  magentoId   Int?     @unique @map("magento_id")
  parentId    String?  @map("parent_id")
  name        String
  slug        String   @unique
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  position    Int      @default(0)
  level       Int      @default(0)
  path        String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  parent            Category?         @relation("CategoryTree", fields: [parentId], references: [id])
  children          Category[]        @relation("CategoryTree")
  productCategories ProductCategory[]

  @@index([magentoId])
  @@index([parentId])
  @@index([slug])
  @@map("categories_catalog")
}

model ProductCatalog {
  id               String    @id @default(uuid())
  magentoId        Int?      @unique @map("magento_id")
  sku              String    @unique
  typeId           String    @map("type_id") // simple, configurable, bundle, grouped
  name             String
  slug             String    @unique
  description      String?   @db.Text
  shortDescription String?   @map("short_description") @db.Text
  shelfLocation    String?   @map("shelf_location")
  binLocation      String?   @map("bin_location")
  price            Decimal?  @db.Decimal(10, 2)
  costPrice        Decimal?  @map("cost_price") @db.Decimal(10, 2)
  specialPrice     Decimal?  @map("special_price") @db.Decimal(10, 2)
  specialPriceFrom DateTime? @map("special_price_from")
  specialPriceTo   DateTime? @map("special_price_to")
  weight           Decimal?  @db.Decimal(10, 2)
  status           String    @default("enabled") // enabled, disabled
  visibility       String    @default("catalog_search") // not_visible, catalog, search, catalog_search
  metaTitle        String?   @map("meta_title")
  metaDescription  String?   @map("meta_description") @db.Text
  metaKeywords     String?   @map("meta_keywords") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  categories      ProductCategory[]
  images          ProductImage[]
  inventory       ProductInventory?
  customOptions   ProductCustomOption[]
  attributeValues ProductAttributeValue[]
  parentRelations ProductRelation[]       @relation("ParentProduct")
  childRelations  ProductRelation[]       @relation("ChildProduct")
  orderLines      OrderLine[]
  cartItems       CartItem[]

  @@index([magentoId])
  @@index([sku])
  @@index([slug])
  @@index([typeId])
  @@index([status])
  @@map("products_catalog")
}

model ProductCategory {
  id         String @id @default(uuid())
  productId  String @map("product_id")
  categoryId String @map("category_id")
  position   Int    @default(0)

  // Relations
  product  ProductCatalog @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@map("product_categories_catalog")
}

model ProductRelation {
  id       String @id @default(uuid())
  parentId String @map("parent_id")
  childId  String @map("child_id")

  // Relations
  parent ProductCatalog @relation("ParentProduct", fields: [parentId], references: [id], onDelete: Cascade)
  child  ProductCatalog @relation("ChildProduct", fields: [childId], references: [id], onDelete: Cascade)

  @@unique([parentId, childId])
  @@index([parentId])
  @@index([childId])
  @@map("product_relations")
}

model ProductAttribute {
  id                 String   @id @default(uuid())
  magentoAttributeId Int?     @map("magento_attribute_id")
  attributeCode      String   @unique @map("attribute_code")
  attributeLabel     String   @map("attribute_label")
  inputType          String   @map("input_type") // select, multiselect, text, textarea, boolean, price
  isRequired         Boolean  @default(false) @map("is_required")
  position           Int      @default(0)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  options ProductAttributeOption[]
  values  ProductAttributeValue[]

  @@index([magentoAttributeId])
  @@map("product_attributes")
}

model ProductAttributeOption {
  id              String  @id @default(uuid())
  attributeId     String  @map("attribute_id")
  magentoOptionId Int?    @map("magento_option_id")
  optionLabel     String  @map("option_label")
  optionValue     String? @map("option_value")
  sortOrder       Int     @default(0) @map("sort_order")

  // Relations
  attribute ProductAttribute        @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  values    ProductAttributeValue[]

  @@index([attributeId])
  @@map("product_attribute_options")
}

model ProductAttributeValue {
  id          String  @id @default(uuid())
  productId   String  @map("product_id")
  attributeId String  @map("attribute_id")
  optionId    String? @map("option_id")
  value       String? @db.Text

  // Relations
  product   ProductCatalog          @relation(fields: [productId], references: [id], onDelete: Cascade)
  attribute ProductAttribute        @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  option    ProductAttributeOption? @relation(fields: [optionId], references: [id], onDelete: SetNull)

  @@unique([productId, attributeId])
  @@index([productId])
  @@index([attributeId])
  @@map("product_attribute_values")
}

model ProductCustomOption {
  id              String   @id @default(uuid())
  productId       String   @map("product_id")
  magentoOptionId Int?     @map("magento_option_id")
  title           String
  type            String // field, area, file, drop_down, radio, checkbox, multiple, date, date_time, time
  isRequire       Boolean  @default(false) @map("is_require")
  sortOrder       Int      @default(0) @map("sort_order")
  price           Decimal? @db.Decimal(10, 2)
  priceType       String   @default("fixed") @map("price_type") // fixed, percent
  sku             String?

  // Relations
  product ProductCatalog             @relation(fields: [productId], references: [id], onDelete: Cascade)
  values  ProductCustomOptionValue[]

  @@index([productId])
  @@map("product_custom_options")
}

model ProductCustomOptionValue {
  id             String   @id @default(uuid())
  optionId       String   @map("option_id")
  magentoValueId Int?     @map("magento_value_id")
  title          String
  price          Decimal? @db.Decimal(10, 2)
  priceType      String   @default("fixed") @map("price_type") // fixed, percent
  sku            String?
  sortOrder      Int      @default(0) @map("sort_order")

  // Relations
  option ProductCustomOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@index([optionId])
  @@map("product_custom_option_values")
}

model ProductImage {
  id             String   @id @default(uuid())
  productId      String   @map("product_id")
  magentoImageId Int?     @map("magento_image_id")
  filePath       String   @map("file_path")
  url            String?
  localPath      String?  @map("local_path") // Local file path after download
  label          String?
  position       Int      @default(0)
  isMain         Boolean  @default(false) @map("is_main")
  isThumbnail    Boolean  @default(false) @map("is_thumbnail")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  product ProductCatalog @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isMain])
  @@map("product_images")
}

model ProductInventory {
  id             String   @id @default(uuid())
  productId      String   @unique @map("product_id")
  sku            String   @unique
  qty            Decimal  @default(0) @db.Decimal(10, 2) // Totale fysieke voorraad
  qtyReserved    Decimal  @default(0) @map("qty_reserved") @db.Decimal(10, 2) // Gereserveerd voor werkorders
  // qtyAvailable = qty - qtyReserved (computed in queries)
  isInStock      Boolean  @default(true) @map("is_in_stock")
  minQty         Decimal  @default(0) @map("min_qty") @db.Decimal(10, 2)
  notifyStockQty Decimal? @map("notify_stock_qty") @db.Decimal(10, 2)
  manageStock    Boolean  @default(true) @map("manage_stock")
  backorders     String   @default("no") // no, notify, yes
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  product ProductCatalog @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([sku])
  @@index([isInStock])
  @@map("product_inventory")
}

model MagentoSyncLog {
  id             String    @id @default(uuid())
  syncType       String    @map("sync_type") // full, incremental, categories, products, inventory
  status         String // running, completed, failed
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")
  totalItems     Int       @default(0) @map("total_items")
  processedItems Int       @default(0) @map("processed_items")
  failedItems    Int       @default(0) @map("failed_items")
  errorMessage   String?   @map("error_message") @db.Text
  details        Json? // Additional sync details

  @@index([status])
  @@index([syncType])
  @@index([startedAt])
  @@map("magento_sync_logs")
}

// ========================================
// BTW / VAT SYSTEM
// ========================================

model VatRate {
  id          String    @id @default(uuid())
  code        String    @unique // "HIGH", "LOW", "ZERO", "REVERSED"
  name        String // "Hoog tarief", "Laag tarief", etc.
  percentage  Decimal   @db.Decimal(5, 2) // 21.00, 9.00, 0.00
  isActive    Boolean   @default(true) @map("is_active")
  isDefault   Boolean   @default(false) @map("is_default")
  validFrom   DateTime  @default(now()) @map("valid_from")
  validUntil  DateTime? @map("valid_until")
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  laborLines LaborLine[]
  partsLines PartsLine[]

  @@index([isActive])
  @@index([isDefault])
  @@map("vat_rates")
}

model VatReport {
  id          String   @id @default(uuid())
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  quarter     Int
  year        Int

  salesSubtotalHigh Decimal @default(0) @map("sales_subtotal_high") @db.Decimal(10, 2)
  salesVatHigh      Decimal @default(0) @map("sales_vat_high") @db.Decimal(10, 2)
  salesSubtotalLow  Decimal @default(0) @map("sales_subtotal_low") @db.Decimal(10, 2)
  salesVatLow       Decimal @default(0) @map("sales_vat_low") @db.Decimal(10, 2)
  salesSubtotalZero Decimal @default(0) @map("sales_subtotal_zero") @db.Decimal(10, 2)

  purchaseSubtotalHigh Decimal @default(0) @map("purchase_subtotal_high") @db.Decimal(10, 2)
  purchaseVatHigh      Decimal @default(0) @map("purchase_vat_high") @db.Decimal(10, 2)
  purchaseSubtotalLow  Decimal @default(0) @map("purchase_subtotal_low") @db.Decimal(10, 2)
  purchaseVatLow       Decimal @default(0) @map("purchase_vat_low") @db.Decimal(10, 2)

  totalSalesVat    Decimal @default(0) @map("total_sales_vat") @db.Decimal(10, 2)
  totalPurchaseVat Decimal @default(0) @map("total_purchase_vat") @db.Decimal(10, 2)
  vatToPay         Decimal @default(0) @map("vat_to_pay") @db.Decimal(10, 2)
  vatToReceive     Decimal @default(0) @map("vat_to_receive") @db.Decimal(10, 2)

  status      String    @default("draft")
  submittedAt DateTime? @map("submitted_at")
  paidAt      DateTime? @map("paid_at")

  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([year, quarter])
  @@index([status])
  @@index([year])
  @@map("vat_reports")
}

// ========================================
// HR & LEAVE MANAGEMENT
// ========================================

model LeaveRequest {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  absenceTypeCode  String    @map("absence_type_code") // VERLOF, ZIEK, DOKTER, etc.
  startDate        DateTime  @map("start_date")
  endDate          DateTime  @map("end_date")
  startTime        String?   @map("start_time") // For partial day leave
  endTime          String?   @map("end_time")   // For partial day leave
  totalDays        Decimal   @map("total_days") @db.Decimal(5, 2)
  totalHours       Decimal?  @map("total_hours") @db.Decimal(6, 2)
  totalMinutes     Int?      @map("total_minutes")
  status           String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  reason           String?   @db.Text
  notes            String?   @db.Text
  reviewedBy       String?   @map("reviewed_by")
  reviewedAt       DateTime? @map("reviewed_at")
  reviewNotes      String?   @map("review_notes") @db.Text
  planningItemId   String?   @unique @map("planning_item_id") // Link to PlanningItem when approved (one-to-one)
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  user          User           @relation("employee", fields: [userId], references: [id], onDelete: Cascade)
  reviewer      User?          @relation("reviewer", fields: [reviewedBy], references: [id])
  planningItem  PlanningItem?  @relation(fields: [planningItemId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@index([planningItemId])
  @@map("leave_requests")
}

model LeaveBalance {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  year        Int
  periodKey   String   @map("period_key") // Format: "YYYY-MM" for monthly accrual
  changeType  String   @map("change_type") // ACCRUAL, DEDUCT, ADJUSTMENT, CARRY_FORWARD
  amountDays  Decimal  @map("amount_days") @db.Decimal(5, 2)
  balanceType String   @map("balance_type") // LEGAL, EXTRA, CARRYOVER, SPECIAL
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   String?  @map("created_by") // User ID who made the change

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, periodKey, balanceType])
  @@index([userId, year])
  @@index([periodKey])
  @@map("leave_balances")
}

model LeaveLedger {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  type            String   // ACCRUAL, TAKEN, ADJUSTMENT, CARRYOVER
  amountMinutes   Int      @map("amount_minutes") // Positive for credit, negative for debit
  periodKey       String?  @map("period_key") // Format: "YYYY-MM" or "CARRYOVER-YYYY"
  leaveRequestId  String?  @map("leave_request_id")
  createdBy       String?  @map("created_by")
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation("ledger", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, periodKey])
  @@index([userId])
  @@index([type])
  @@index([periodKey])
  @@map("leave_ledger")
}
